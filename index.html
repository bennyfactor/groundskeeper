<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groundskeeper - Lawnchair Backup Viewer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ¿</text></svg>">
    <meta name="description" content="View and explore Lawnchair launcher backup files in your browser. Privacy-first: files never leave your device.">
    <meta property="og:title" content="Groundskeeper - Lawnchair Backup Viewer">
    <meta property="og:description" content="View and explore Lawnchair launcher backup files in your browser.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.11.0/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.4.0/dist/protobuf.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="groundskeeper()" x-init="init()" class="min-h-screen">
        <!-- Loading state -->
        <div x-show="loading" x-cloak class="flex items-center justify-center h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading...</p>
            </div>
        </div>

        <!-- Main app -->
        <div x-show="!loading" class="min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Groundskeeper</h1>
                        <p class="text-sm text-gray-500" x-text="backup ? backup.name : 'Lawnchair Backup Viewer'"></p>
                    </div>
                    <button
                        x-show="backup"
                        @click="resetBackup()"
                        class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
                    >
                        Load different file
                    </button>
                </div>
            </header>

            <!-- No file loaded - show drop zone -->
            <div x-show="!backup && !novaMode" class="max-w-2xl mx-auto mt-12 px-4">
                <div
                    @dragover.prevent="dragging = true"
                    @dragleave.prevent="dragging = false"
                    @drop.prevent="handleDrop($event)"
                    :class="dragging ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-white'"
                    class="border-2 border-dashed rounded-lg p-12 text-center transition-colors"
                >
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="mt-4 text-lg text-gray-600">Drop your <code class="bg-gray-100 px-1 rounded">.lawnchairbackup</code> file here</p>
                    <p class="mt-2 text-sm text-gray-500">or</p>
                    <label class="mt-2 inline-block cursor-pointer">
                        <span class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Browse files
                        </span>
                        <input type="file" class="hidden" accept=".lawnchairbackup,.zip" @change="handleFileSelect($event)">
                    </label>
                    <p class="mt-6 text-sm text-gray-400">
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€ or â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    </p>
                    <p class="mt-4 text-sm text-gray-600">Migrating from Nova Launcher?</p>
                    <label class="mt-2 inline-block cursor-pointer">
                        <span class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">
                            Import Nova Backup
                        </span>
                        <input type="file" class="hidden" accept=".novabackup,.zip" @change="handleNovaFileSelect($event)">
                    </label>
                    <p class="mt-6 text-xs text-gray-400">Your backup stays on your device. Nothing is uploaded.</p>
                </div>
            </div>

            <!-- Error display -->
            <div x-show="error" class="max-w-2xl mx-auto mt-4 px-4">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="font-medium text-red-800">Error loading backup</p>
                        <p class="text-sm text-red-600 mt-1" x-text="error"></p>
                    </div>
                    <button @click="error = null" class="ml-auto text-red-400 hover:text-red-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Nova Import Preview -->
            <div x-show="novaMode && novaPreview" class="max-w-4xl mx-auto mt-8 px-4">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Nova Backup Preview</h2>
                    <p class="text-sm text-gray-500 mb-6" x-text="novaBackup?.name"></p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Will Transfer -->
                        <div>
                            <h3 class="flex items-center gap-2 text-green-700 font-semibold mb-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Will Transfer
                            </h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm">App shortcuts</span>
                                    <span class="text-sm font-medium text-green-700" x-text="novaPreview?.willTransfer?.apps?.length || 0"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm">Folders</span>
                                    <span class="text-sm font-medium text-green-700" x-text="novaPreview?.willTransfer?.folders?.length || 0"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm">Dock items</span>
                                    <span class="text-sm font-medium text-green-700" x-text="novaPreview?.willTransfer?.dock?.length || 0"></span>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Grid Size</p>
                                <p class="text-sm font-medium" x-text="`${novaBackup?.gridCols || 5} x ${novaBackup?.gridRows || 6}`"></p>
                            </div>
                            <template x-if="novaBackup?.gridCols > 7 || novaBackup?.gridRows > 8">
                                <div class="mt-2 p-2 bg-amber-50 border border-amber-200 rounded text-xs text-amber-700">
                                    Large grid size may not display correctly in Lawnchair
                                </div>
                            </template>
                        </div>

                        <!-- Won't Transfer -->
                        <div>
                            <h3 class="flex items-center gap-2 text-amber-700 font-semibold mb-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                Won't Transfer
                            </h3>
                            <div class="space-y-2">
                                <template x-if="novaPreview?.wontTransfer?.widgets?.length">
                                    <div class="p-3 bg-amber-50 rounded-lg">
                                        <p class="text-sm font-medium text-amber-800 mb-1">Widgets</p>
                                        <p class="text-xs text-amber-600">Must be re-added manually in Lawnchair</p>
                                        <ul class="mt-2 text-xs text-gray-600 space-y-1">
                                            <template x-for="widget in novaPreview?.wontTransfer?.widgets" :key="widget.provider">
                                                <li x-text="widget.title"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                                <template x-if="novaPreview?.wontTransfer?.dockOverflow?.length">
                                    <div class="p-3 bg-amber-50 rounded-lg">
                                        <p class="text-sm font-medium text-amber-800 mb-1">Dock overflow</p>
                                        <p class="text-xs text-amber-600" x-text="`${novaPreview.wontTransfer.dockOverflow.length} items exceed Lawnchair's dock limit`"></p>
                                    </div>
                                </template>
                                <template x-if="!novaPreview?.wontTransfer?.widgets?.length && !novaPreview?.wontTransfer?.dockOverflow?.length">
                                    <p class="text-sm text-gray-500 italic">Nothing lost in this backup!</p>
                                </template>
                            </div>

                            <div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500">
                                <p class="font-medium text-gray-600 mb-1">Also not transferred:</p>
                                <ul class="list-disc list-inside space-y-0.5">
                                    <li>Gestures</li>
                                    <li>Custom icons</li>
                                    <li>App drawer groups</li>
                                    <li>Visual settings</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-8 flex flex-wrap gap-3">
                        <button
                            @click="generateLawnchairBackup()"
                            class="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                        >
                            Generate Lawnchair Backup
                        </button>
                        <button
                            @click="cancelNovaImport()"
                            class="px-4 py-2.5 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- File loaded - Desktop layout -->
            <div x-show="backup" class="hidden sm:flex h-[calc(100vh-73px)]">
                <!-- Sidebar -->
                <aside class="w-56 bg-white border-r overflow-y-auto">
                    <nav class="p-4 space-y-1">
                        <button
                            @click="currentView = 'info'"
                            :class="currentView === 'info' ? 'bg-green-100 text-green-800' : 'text-gray-600 hover:bg-gray-100'"
                            class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                        >
                            Backup Info
                        </button>

                        <div class="pt-2">
                            <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Screens</p>
                            <template x-for="screen in backup?.layout?.screens" :key="screen.number">
                                <button
                                    @click="currentView = 'screen-' + screen.number"
                                    :class="currentView === 'screen-' + screen.number ? 'bg-green-100 text-green-800' : 'text-gray-600 hover:bg-gray-100'"
                                    class="w-full text-left px-3 py-2 rounded-lg text-sm transition-colors"
                                >
                                    <span x-text="'Screen ' + (screen.number + 1)"></span>
                                    <span class="text-xs text-gray-400 ml-1" x-text="'(' + screen.items.length + ')'"></span>
                                </button>
                            </template>
                        </div>

                        <button
                            @click="currentView = 'dock'"
                            :class="currentView === 'dock' ? 'bg-green-100 text-green-800' : 'text-gray-600 hover:bg-gray-100'"
                            class="w-full text-left px-3 py-2 rounded-lg text-sm transition-colors"
                        >
                            Dock
                            <span class="text-xs text-gray-400 ml-1" x-text="'(' + (backup?.layout?.dock?.length || 0) + ')'"></span>
                        </button>

                        <button
                            x-show="backup?.wallpaper"
                            @click="currentView = 'wallpaper'"
                            :class="currentView === 'wallpaper' ? 'bg-green-100 text-green-800' : 'text-gray-600 hover:bg-gray-100'"
                            class="w-full text-left px-3 py-2 rounded-lg text-sm transition-colors"
                        >
                            Wallpaper
                        </button>
                    </nav>
                </aside>

                <!-- Main content -->
                <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
                    <!-- Info View -->
                    <div x-show="currentView === 'info'">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Backup Information</h2>
                        <!-- Info content here -->
                        <div class="grid grid-cols-2 gap-4 max-w-md">
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <p class="text-xs text-gray-500">Lawnchair Version</p>
                                <p class="font-medium" x-text="backup?.info?.lawnchairVersion"></p>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <p class="text-xs text-gray-500">Created</p>
                                <p class="font-medium" x-text="backup?.info?.createdAtDate?.toLocaleDateString()"></p>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <p class="text-xs text-gray-500">Grid Size</p>
                                <p class="font-medium" x-text="backup?.info?.gridState?.gridSize"></p>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <p class="text-xs text-gray-500">Dock Slots</p>
                                <p class="font-medium" x-text="backup?.info?.gridState?.hotseatCount"></p>
                            </div>
                        </div>

                        <!-- Screenshot preview -->
                        <div x-show="backup?.screenshot" class="mt-6">
                            <h3 class="text-sm font-medium text-gray-600 mb-2">Preview</h3>
                            <img :src="backup?.screenshot" class="rounded-lg border shadow-sm max-h-80 object-contain">
                        </div>
                    </div>

                    <!-- Screen View -->
                    <template x-for="screen in backup?.layout?.screens" :key="screen.number">
                        <div x-show="currentView === 'screen-' + screen.number">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4" x-text="'Screen ' + (screen.number + 1)"></h2>

                            <!-- Grid -->
                            <div
                                class="relative bg-gray-200 p-2 rounded-lg"
                                :style="`
                                    display: grid;
                                    grid-template-columns: repeat(${backup?.info?.gridState?.cols || 5}, 64px);
                                    grid-template-rows: repeat(${backup?.info?.gridState?.rows || 6}, 64px);
                                    gap: 4px;
                                `"
                            >
                                <!-- Empty cells for background -->
                                <template x-for="i in ((backup?.info?.gridState?.cols || 5) * (backup?.info?.gridState?.rows || 6))" :key="'cell-' + i">
                                    <div class="bg-white/50 rounded-lg"></div>
                                </template>

                                <!-- Items positioned on grid -->
                                <template x-for="item in screen.items" :key="item._id">
                                    <div
                                        class="absolute bg-white rounded-lg shadow-sm flex items-center justify-center p-1 ring-1 ring-gray-200 hover:ring-green-400 transition-shadow cursor-pointer"
                                        :style="`
                                            left: calc(8px + ${item.cellX} * 68px);
                                            top: calc(8px + ${item.cellY} * 68px);
                                            width: calc(${item.spanX || 1} * 64px + ${(item.spanX || 1) - 1} * 4px);
                                            height: calc(${item.spanY || 1} * 64px + ${(item.spanY || 1) - 1} * 4px);
                                        `"
                                        :title="item.title + (item.packageName ? ' (' + item.packageName + ')' : '')"
                                        @click="item.itemType === 2 ? selectedFolder = item : null"
                                    >
                                        <div class="text-center overflow-hidden">
                                            <span class="text-xl" x-text="getItemIcon(item)"></span>
                                            <p
                                                class="text-[10px] leading-tight truncate mt-1"
                                                :class="(item.spanX || 1) > 1 ? 'max-w-[100px]' : 'max-w-[50px]'"
                                                x-text="item.title || (item.itemType === 4 ? 'Widget' : 'Untitled')"
                                            ></p>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Items list -->
                            <div class="mt-6">
                                <h3 class="text-sm font-medium text-gray-600 mb-2">Items on this screen</h3>
                                <div class="bg-white rounded-lg shadow-sm divide-y">
                                    <template x-for="item in screen.items" :key="item._id">
                                        <div class="px-4 py-2 flex items-center gap-3">
                                            <span class="text-xl" x-text="getItemIcon(item)"></span>
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium truncate" x-text="item.title || 'Untitled'"></p>
                                                <p class="text-xs text-gray-500" x-text="item.packageName || getItemTypeLabel(item.itemType)"></p>
                                            </div>
                                            <span class="text-xs text-gray-400" x-text="`(${item.cellX}, ${item.cellY})`"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Dock View -->
                    <div x-show="currentView === 'dock'">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Dock</h2>

                        <!-- Visual dock -->
                        <div class="inline-flex gap-2 bg-gray-200 p-3 rounded-2xl">
                            <template x-for="item in backup?.layout?.dock" :key="item._id">
                                <div
                                    class="w-14 h-14 bg-white rounded-xl flex items-center justify-center shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                                    :title="item.title + (item.packageName ? ' (' + item.packageName + ')' : '')"
                                >
                                    <div class="text-center">
                                        <span class="text-2xl" x-text="getItemIcon(item)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Dock items list -->
                        <div class="mt-6 max-w-md">
                            <h3 class="text-sm font-medium text-gray-600 mb-2">Dock Items</h3>
                            <div class="bg-white rounded-lg shadow-sm divide-y">
                                <template x-for="(item, index) in backup?.layout?.dock" :key="item._id">
                                    <div class="px-4 py-2 flex items-center gap-3">
                                        <span class="text-gray-400 text-sm w-4" x-text="index + 1"></span>
                                        <span class="text-xl" x-text="getItemIcon(item)"></span>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-medium truncate" x-text="item.title || 'Untitled'"></p>
                                            <p class="text-xs text-gray-500 truncate" x-text="item.packageName || getItemTypeLabel(item.itemType)"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Wallpaper View -->
                    <div x-show="currentView === 'wallpaper'">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Wallpaper</h2>
                        <img :src="backup?.wallpaper" class="rounded-lg shadow-lg max-w-full">
                    </div>
                </main>
            </div>

            <!-- Mobile layout -->
            <div x-show="backup" class="sm:hidden flex flex-col h-[calc(100vh-73px)]">
                <!-- Tab bar -->
                <div class="bg-white border-b px-2 py-1 flex gap-1 overflow-x-auto">
                    <button
                        @click="mobileTab = 'info'"
                        :class="mobileTab === 'info' ? 'bg-green-100 text-green-800' : 'text-gray-600'"
                        class="px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
                    >Info</button>
                    <button
                        @click="mobileTab = 'screens'"
                        :class="mobileTab === 'screens' ? 'bg-green-100 text-green-800' : 'text-gray-600'"
                        class="px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
                    >Screens</button>
                    <button
                        @click="mobileTab = 'dock'"
                        :class="mobileTab === 'dock' ? 'bg-green-100 text-green-800' : 'text-gray-600'"
                        class="px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
                    >Dock</button>
                    <button
                        x-show="backup?.wallpaper"
                        @click="mobileTab = 'wallpaper'"
                        :class="mobileTab === 'wallpaper' ? 'bg-green-100 text-green-800' : 'text-gray-600'"
                        class="px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
                    >Wallpaper</button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-4">
                    <!-- Info tab -->
                    <div x-show="mobileTab === 'info'">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <p class="text-xs text-gray-500">Version</p>
                                <p class="font-medium" x-text="backup?.info?.lawnchairVersion"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <p class="text-xs text-gray-500">Created</p>
                                <p class="font-medium" x-text="backup?.info?.createdAtDate?.toLocaleDateString()"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <p class="text-xs text-gray-500">Grid</p>
                                <p class="font-medium" x-text="backup?.info?.gridState?.gridSize"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <p class="text-xs text-gray-500">Dock Slots</p>
                                <p class="font-medium" x-text="backup?.info?.gridState?.hotseatCount"></p>
                            </div>
                        </div>
                        <img x-show="backup?.screenshot" :src="backup?.screenshot" class="mt-4 rounded-lg shadow-sm w-full">
                    </div>

                    <!-- Screens tab -->
                    <div x-show="mobileTab === 'screens'">
                        <template x-if="backup?.layout?.screens?.length">
                            <div>
                                <!-- Screen selector -->
                                <div class="flex items-center justify-between mb-4">
                                    <button
                                        @click="mobileScreenIndex = Math.max(0, mobileScreenIndex - 1)"
                                        :disabled="mobileScreenIndex === 0"
                                        class="p-2 rounded-full hover:bg-gray-100 disabled:opacity-30"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <span class="text-sm text-gray-600">
                                        Screen <span x-text="mobileScreenIndex + 1"></span> of <span x-text="backup?.layout?.screens?.length"></span>
                                    </span>
                                    <button
                                        @click="mobileScreenIndex = Math.min(backup?.layout?.screens?.length - 1, mobileScreenIndex + 1)"
                                        :disabled="mobileScreenIndex >= backup?.layout?.screens?.length - 1"
                                        class="p-2 rounded-full hover:bg-gray-100 disabled:opacity-30"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Items list for current screen -->
                                <div class="bg-white rounded-lg shadow-sm divide-y">
                                    <template x-for="item in backup?.layout?.screens[mobileScreenIndex]?.items" :key="item._id">
                                        <div
                                            class="px-4 py-2 flex items-center gap-3"
                                            @click="item.itemType === 2 ? selectedFolder = item : null"
                                            :class="item.itemType === 2 ? 'cursor-pointer hover:bg-gray-50' : ''"
                                        >
                                            <span class="text-xl" x-text="getItemIcon(item)"></span>
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium truncate" x-text="item.title || 'Untitled'"></p>
                                                <p class="text-xs text-gray-500 truncate" x-text="item.packageName || getItemTypeLabel(item.itemType)"></p>
                                            </div>
                                            <template x-if="item.itemType === 2">
                                                <span class="text-xs text-gray-400" x-text="(item.contents?.length || 0) + ' items'"></span>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Dock tab -->
                    <div x-show="mobileTab === 'dock'">
                        <div class="bg-white rounded-lg shadow-sm divide-y">
                            <template x-for="item in backup?.layout?.dock" :key="item._id">
                                <div class="px-4 py-2 flex items-center gap-3">
                                    <span class="text-xl" x-text="getItemIcon(item)"></span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium truncate" x-text="item.title || 'Untitled'"></p>
                                        <p class="text-xs text-gray-500 truncate" x-text="item.packageName || 'App'"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Wallpaper tab -->
                    <div x-show="mobileTab === 'wallpaper'">
                        <img :src="backup?.wallpaper" class="rounded-lg shadow-lg w-full">
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer (shown when no backup loaded) -->
        <footer x-show="!backup" class="fixed bottom-0 inset-x-0 py-4 text-center text-xs text-gray-400">
            <a href="https://github.com/bennyfactor/groundskeeper" class="hover:text-gray-600">View on GitHub</a>
            <span class="mx-2">â€¢</span>
            <span>Made for the Lawnchair community</span>
        </footer>

        <!-- Folder Modal -->
        <div
            x-show="selectedFolder"
            x-cloak
            @click.self="selectedFolder = null"
            @keydown.escape.window="selectedFolder = null"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
        >
            <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 overflow-hidden" @click.stop>
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800" x-text="selectedFolder?.title || 'Folder'"></h3>
                        <button @click="selectedFolder = null" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" x-text="(selectedFolder?.contents?.length || 0) + ' items'"></p>
                </div>
                <div class="p-4 max-h-80 overflow-y-auto">
                    <div class="grid grid-cols-4 gap-2">
                        <template x-for="item in selectedFolder?.contents" :key="item._id">
                            <div class="flex flex-col items-center p-2">
                                <span class="text-2xl" x-text="getItemIcon(item)"></span>
                                <p class="text-[10px] text-center mt-1 truncate w-full" x-text="item.title || 'Untitled'"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function groundskeeper() {
        return {
            loading: true,
            sqlReady: false,
            dragging: false,
            backup: null,
            error: null,
            currentView: 'info',  // 'info', 'screen-0', 'dock', 'wallpaper'
            selectedFolder: null,
            mobileTab: 'info',  // 'info', 'screens', 'dock', 'wallpaper'
            mobileScreenIndex: 0,
            novaMode: false,           // true when processing Nova backup
            novaBackup: null,          // parsed Nova data for preview
            novaPreview: null,         // what will/won't transfer

            async init() {
                // Initialize sql.js
                this.SQL = await initSqlJs({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.11.0/dist/${file}`
                });
                this.sqlReady = true;
                this.loading = false;
                console.log('Groundskeeper initialized');
            },

            resetBackup() {
                // Revoke object URLs to prevent memory leaks
                if (this.backup?.screenshot) URL.revokeObjectURL(this.backup.screenshot);
                if (this.backup?.wallpaper) URL.revokeObjectURL(this.backup.wallpaper);

                this.backup = null;
                this.currentView = 'info';
                this.mobileTab = 'info';
                this.mobileScreenIndex = 0;
                this.selectedFolder = null;
            },

            handleDrop(event) {
                this.dragging = false;
                const file = event.dataTransfer.files[0];
                if (file) {
                    if (file.name.endsWith('.novabackup')) {
                        this.loadNovaFile(file);
                    } else {
                        this.loadFile(file);
                    }
                }
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.loadFile(file);
                }
            },

            handleNovaFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.loadNovaFile(file);
                }
            },

            async loadFile(file) {
                console.log('Loading file:', file.name);
                this.loading = true;
                this.error = null;

                try {
                    // Validate file extension
                    if (!file.name.endsWith('.lawnchairbackup') && !file.name.endsWith('.zip')) {
                        throw new Error('Please select a .lawnchairbackup file');
                    }

                    const zip = await JSZip.loadAsync(file);

                    // Validate it's a Lawnchair backup
                    if (!zip.file('launcher.db')) {
                        throw new Error('This doesn\'t appear to be a valid Lawnchair backup (missing launcher.db)');
                    }

                    // List contents for debugging
                    const files = [];
                    zip.forEach((path, entry) => {
                        files.push({ path, dir: entry.dir, size: entry._data?.uncompressedSize || 0 });
                    });
                    console.log('Backup contents:', files);

                    // Extract what we need
                    const backup = {
                        name: file.name,
                        files: files
                    };

                    // Screenshot
                    const screenshotFile = zip.file('screenshot.png');
                    if (screenshotFile) {
                        const blob = await screenshotFile.async('blob');
                        backup.screenshot = URL.createObjectURL(blob);
                    }

                    // Wallpaper
                    const wallpaperFile = zip.file('wallpaper.png');
                    if (wallpaperFile) {
                        const blob = await wallpaperFile.async('blob');
                        backup.wallpaper = URL.createObjectURL(blob);
                    }

                    // Parse info.pb
                    const infoFile = zip.file('info.pb');
                    if (infoFile) {
                        const infoData = await infoFile.async('arraybuffer');
                        backup.info = await this.parseBackupInfo(infoData);
                        console.log('BackupInfo:', backup.info);
                    }

                    // Parse launcher.db
                    const dbFile = zip.file('launcher.db');
                    if (dbFile) {
                        const dbData = await dbFile.async('arraybuffer');
                        backup.layout = this.parseDatabase(dbData);
                        console.log('Layout:', backup.layout);
                    }

                    this.backup = backup;
                    // console.log('Backup parsed:', backup);
                } catch (error) {
                    console.error('Error loading backup:', error);
                    this.error = error.message;
                } finally {
                    this.loading = false;
                }
            },

            formatSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            },

            async parseBackupInfo(data) {
                const root = await protobuf.load('proto/lawnchair.proto');
                const BackupInfo = root.lookupType('BackupInfo');
                const message = BackupInfo.decode(new Uint8Array(data));
                const info = BackupInfo.toObject(message, {
                    longs: Number,
                    defaults: true
                });

                // Parse grid size string (e.g., "5x7")
                if (info.gridState?.gridSize) {
                    const [cols, rows] = info.gridState.gridSize.split('x').map(Number);
                    info.gridState.cols = cols;
                    info.gridState.rows = rows;
                }

                // Convert timestamp
                if (info.createdAt?.seconds) {
                    info.createdAtDate = new Date(info.createdAt.seconds * 1000);
                }

                return info;
            },

            getItemAt(items, x, y) {
                return items.find(item =>
                    item.cellX === x &&
                    item.cellY === y &&
                    item.container === -100  // Desktop only
                );
            },

            getItemTypeLabel(itemType) {
                const types = { 0: 'App', 2: 'Folder', 4: 'Widget', 6: 'Shortcut' };
                return types[itemType] || 'Unknown';
            },

            getItemIcon(item) {
                if (item.itemType === 2) return 'ðŸ“';
                if (item.itemType === 4) {
                    // Try to identify widget type from provider
                    if (item.appWidgetProvider?.includes('weather')) return 'ðŸŒ¤ï¸';
                    if (item.appWidgetProvider?.includes('clock')) return 'ðŸ•';
                    if (item.appWidgetProvider?.includes('calendar')) return 'ðŸ“…';
                    if (item.appWidgetProvider?.includes('music')) return 'ðŸŽµ';
                    return 'ðŸ“¦';
                }
                return 'ðŸ“±';
            },

            parseDatabase(data) {
                const db = new this.SQL.Database(new Uint8Array(data));

                // Query favorites table
                const favoritesResult = db.exec(`
                    SELECT _id, title, intent, container, screen,
                           cellX, cellY, spanX, spanY, itemType,
                           appWidgetProvider, icon, rank
                    FROM favorites
                `);

                if (!favoritesResult.length) {
                    return { screens: [], dock: [], folders: {} };
                }

                const columns = favoritesResult[0].columns;
                const rows = favoritesResult[0].values;

                // Convert to objects
                const items = rows.map(row => {
                    const item = {};
                    columns.forEach((col, i) => item[col] = row[i]);

                    // Parse intent to get package name
                    if (item.intent) {
                        const match = item.intent.match(/component=([^;/]+)/);
                        if (match) item.packageName = match[1];
                    }

                    return item;
                });

                // Group by container
                const CONTAINER_DESKTOP = -100;
                const CONTAINER_HOTSEAT = -101;

                const screens = {};
                const dock = [];
                const folders = {};

                items.forEach(item => {
                    if (item.container === CONTAINER_DESKTOP) {
                        const screenNum = item.screen || 0;
                        if (!screens[screenNum]) screens[screenNum] = [];
                        screens[screenNum].push(item);
                    } else if (item.container === CONTAINER_HOTSEAT) {
                        dock.push(item);
                    } else if (item.container > 0) {
                        // Item is inside a folder
                        if (!folders[item.container]) folders[item.container] = [];
                        folders[item.container].push(item);
                    }
                });

                // Sort dock by rank/cellX
                dock.sort((a, b) => (a.rank || a.cellX) - (b.rank || b.cellX));

                // Attach folder contents to folder items
                items.filter(i => i.itemType === 2).forEach(folder => {
                    folder.contents = folders[folder._id] || [];
                    folder.contents.sort((a, b) => a.rank - b.rank);
                });

                db.close();

                return {
                    screens: Object.entries(screens)
                        .sort(([a], [b]) => Number(a) - Number(b))
                        .map(([num, items]) => ({ number: Number(num), items })),
                    dock,
                    allItems: items
                };
            },

            async loadNovaFile(file) {
                console.log('Loading Nova backup:', file.name);
                this.loading = true;
                this.error = null;
                this.novaMode = true;

                try {
                    if (!file.name.endsWith('.novabackup') && !file.name.endsWith('.zip')) {
                        throw new Error('Please select a .novabackup file');
                    }

                    const zip = await JSZip.loadAsync(file);

                    // Nova backups use nova.db; older versions may use launcher.db
                    const dbFile = zip.file('nova.db') || zip.file('launcher.db');
                    if (!dbFile) {
                        throw new Error('This doesn\'t appear to be a valid Nova backup (missing nova.db)');
                    }

                    const dbData = await dbFile.async('arraybuffer');
                    const novaData = this.parseNovaDatabase(dbData);

                    // Parse grid settings from nova.xml or preferences XML
                    let gridCols = 5, gridRows = 6, dockCols = 5;
                    const novaXml = zip.file('nova.xml');
                    const prefsFile = Object.keys(zip.files).find(f => f.endsWith('_launcher_preferences.xml'));
                    const xmlSource = novaXml || (prefsFile ? zip.file(prefsFile) : null);
                    if (xmlSource) {
                        const xml = await xmlSource.async('text');
                        const parsed = this.parseNovaPreferences(xml);
                        gridCols = parsed.gridCols || gridCols;
                        gridRows = parsed.gridRows || gridRows;
                        dockCols = parsed.dockCols || dockCols;
                    }

                    this.novaBackup = {
                        name: file.name,
                        ...novaData,
                        gridCols,
                        gridRows,
                        dockCols
                    };

                    this.novaPreview = this.generateNovaPreview(this.novaBackup);

                    // Check for empty backup
                    if (novaData.items.length === 0) {
                        console.warn('Nova backup appears to be empty');
                    }

                    // console.log('Nova backup parsed:', this.novaBackup);
                    // console.log('Preview:', this.novaPreview);
                } catch (error) {
                    console.error('Error loading Nova backup:', error);
                    this.error = error.message;
                    this.novaMode = false;
                } finally {
                    this.loading = false;
                }
            },

            parseNovaDatabase(data) {
                const db = new this.SQL.Database(new Uint8Array(data));

                let columns;
                try {
                    const tableInfo = db.exec("PRAGMA table_info(favorites)");
                    columns = tableInfo[0].values.map(row => row[1]);
                } catch (e) {
                    db.close();
                    throw new Error('Could not read favorites table');
                }

                const favoritesResult = db.exec(`
                    SELECT _id, title, intent, container, screen,
                           cellX, cellY, spanX, spanY, itemType,
                           appWidgetProvider, rank
                    FROM favorites
                `);

                if (!favoritesResult.length) {
                    db.close();
                    return { items: [], screens: [], dock: [], folders: {}, widgets: [] };
                }

                const cols = favoritesResult[0].columns;
                const rows = favoritesResult[0].values;

                const items = rows.map(row => {
                    const item = {};
                    cols.forEach((col, i) => item[col] = row[i]);
                    if (item.intent) {
                        const match = item.intent.match(/component=([^;/]+)/);
                        if (match) item.packageName = match[1];
                    }
                    // Round float positions (Nova sub-grid uses half-cell values)
                    item.cellX = Math.round(item.cellX || 0);
                    item.cellY = Math.round(item.cellY || 0);
                    item.spanX = Math.max(1, Math.round(item.spanX || 1));
                    item.spanY = Math.max(1, Math.round(item.spanY || 1));
                    return item;
                }).filter(item =>
                    // Filter out metadata rows and invalid entries
                    item._id > 0 && item.itemType >= 0
                ).map(item => {
                    // Convert Nova app drawer action to Lawnchair all-apps intent
                    if (item.intent && item.intent.includes('LAUNCHER_ACTION=APP_DRAWER')) {
                        item.intent = '#Intent;action=android.intent.action.ALL_APPS;component=app.lawnchair/.LawnchairLauncher;end';
                        item.title = 'All apps';
                        item.isAllApps = true;
                    }
                    return item;
                });

                const CONTAINER_DESKTOP = -100;
                const CONTAINER_HOTSEAT = -101;

                const screens = {};
                const dock = [];
                const folders = {};
                const widgets = [];

                items.forEach(item => {
                    if (item.itemType === 4) {
                        widgets.push(item);
                    }

                    if (item.container === CONTAINER_DESKTOP) {
                        const screenNum = item.screen || 0;
                        if (!screens[screenNum]) screens[screenNum] = [];
                        screens[screenNum].push(item);
                    } else if (item.container === CONTAINER_HOTSEAT) {
                        dock.push(item);
                    } else if (item.container > 0) {
                        if (!folders[item.container]) folders[item.container] = [];
                        folders[item.container].push(item);
                    }
                });

                dock.sort((a, b) => (a.rank ?? a.cellX) - (b.rank ?? b.cellX));

                items.filter(i => i.itemType === 2).forEach(folder => {
                    folder.contents = folders[folder._id] || [];
                    folder.contents.sort((a, b) => (a.rank ?? 0) - (b.rank ?? 0));
                });

                db.close();

                return {
                    items,
                    screens: Object.entries(screens)
                        .sort(([a], [b]) => Number(a) - Number(b))
                        .map(([num, items]) => ({ number: Number(num), items })),
                    dock,
                    widgets,
                    folders
                };
            },

            parseNovaPreferences(xml) {
                const result = { gridCols: 5, gridRows: 6, dockCols: 5 };

                // Nova XML uses attribute format: <int name="key" value="N" />
                // or text content format: <int name="key">N</int>
                const getInt = (name) => {
                    const attrMatch = xml.match(new RegExp(`name="${name}"[^>]*value="(\\d+)"`));
                    if (attrMatch) return parseInt(attrMatch[1], 10);
                    const textMatch = xml.match(new RegExp(`name="${name}"[^>]*>(\\d+)<`));
                    if (textMatch) return parseInt(textMatch[1], 10);
                    return null;
                };

                result.gridCols = getInt('desktop_grid_cols') || getInt('desktop_grid_columns') || result.gridCols;
                result.gridRows = getInt('desktop_grid_rows') || result.gridRows;
                result.dockCols = getInt('dock_grid_cols') || getInt('dock_icons') || result.dockCols;

                return result;
            },

            generateNovaPreview(novaBackup) {
                const willTransfer = { apps: [], folders: [], dock: [] };
                const wontTransfer = { widgets: [], dockOverflow: [] };

                novaBackup.screens.forEach(screen => {
                    screen.items.forEach(item => {
                        if ((item.itemType === 0 || item.itemType === 6) && item.intent) {
                            willTransfer.apps.push(item);
                        } else if (item.itemType === 2) {
                            willTransfer.folders.push({
                                ...item,
                                contentCount: item.contents?.length || 0
                            });
                        }
                    });
                });

                novaBackup.widgets.forEach(widget => {
                    wontTransfer.widgets.push({
                        title: widget.title || this.getWidgetName(widget.appWidgetProvider) || 'Widget',
                        provider: widget.appWidgetProvider
                    });
                });

                const hotseatLimit = novaBackup.dockCols || 5;
                novaBackup.dock.forEach((item, index) => {
                    if (index < hotseatLimit) {
                        willTransfer.dock.push(item);
                    } else {
                        wontTransfer.dockOverflow.push(item);
                    }
                });

                return { willTransfer, wontTransfer };
            },

            generateAllAppsIcon() {
                // Draw the AOSP 6-dot all-apps icon (3 cols x 2 rows)
                const size = 192;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                const dotRadius = 12;
                const cols = 3;
                const rows = 2;
                const spacingX = size / (cols + 1);
                const spacingY = size / (rows + 1);

                ctx.fillStyle = '#ffffff';
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const x = spacingX * (col + 1);
                        const y = spacingY * (row + 1);
                        ctx.beginPath();
                        ctx.arc(x, y, dotRadius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Convert to PNG blob for SQLite
                const dataUrl = canvas.toDataURL('image/png');
                const binary = atob(dataUrl.split(',')[1]);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes;
            },

            getWidgetName(provider) {
                if (!provider) return null;
                const parts = provider.split('/');
                const className = parts[parts.length - 1];
                return className.replace(/([A-Z])/g, ' $1').trim();
            },

            cancelNovaImport() {
                this.novaMode = false;
                this.novaBackup = null;
                this.novaPreview = null;
            },

            async generateLawnchairBackup() {
                if (!this.novaBackup) return;

                this.loading = true;
                try {
                    const zip = new JSZip();

                    // Generate launcher.db
                    const dbBuffer = this.generateLawnchairDatabase();
                    zip.file('launcher.db', dbBuffer);

                    // Generate info.pb
                    const infoBuffer = await this.generateLawnchairInfo();
                    zip.file('info.pb', infoBuffer);

                    // Generate and download the zip
                    const blob = await zip.generateAsync({ type: 'blob' });
                    const filename = this.novaBackup.name.replace('.novabackup', '') + '.lawnchairbackup';

                    // Download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    console.log('Generated Lawnchair backup:', filename);
                } catch (error) {
                    console.error('Error generating backup:', error);
                    this.error = 'Failed to generate Lawnchair backup: ' + error.message;
                } finally {
                    this.loading = false;
                }
            },

            generateLawnchairDatabase() {
                const db = new this.SQL.Database();

                // Create favorites table (Lawnchair schema)
                db.run(`
                    CREATE TABLE favorites (
                        _id INTEGER PRIMARY KEY,
                        title TEXT,
                        intent TEXT,
                        container INTEGER NOT NULL,
                        screen INTEGER,
                        cellX INTEGER NOT NULL,
                        cellY INTEGER NOT NULL,
                        spanX INTEGER NOT NULL DEFAULT 1,
                        spanY INTEGER NOT NULL DEFAULT 1,
                        itemType INTEGER NOT NULL,
                        appWidgetProvider TEXT,
                        appWidgetId INTEGER,
                        icon BLOB,
                        rank INTEGER NOT NULL DEFAULT 0
                    )
                `);

                // Insert items (excluding widgets)
                const stmt = db.prepare(`
                    INSERT INTO favorites (_id, title, intent, container, screen, cellX, cellY, spanX, spanY, itemType, icon, rank)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `);

                // Generate all-apps icon (6 dots in 2 rows of 3)
                const allAppsIcon = this.generateAllAppsIcon();

                let id = 1;
                const idMap = {}; // Map old IDs to new IDs for folders

                const insertItem = (item, container, screen, cellX, cellY, rank) => {
                    if (item.itemType === 4) return; // Skip widgets
                    if (!item.intent && item.itemType !== 2) return; // Skip items with no intent (except folders)

                    const oldId = item._id;
                    idMap[oldId] = id;

                    // All-apps shortcut uses itemType 1 (SHORTCUT) with embedded icon
                    const itemType = item.isAllApps ? 1 : item.itemType;
                    const icon = item.isAllApps ? allAppsIcon : null;

                    stmt.run([
                        id++,
                        item.title,
                        item.intent,
                        container,
                        screen,
                        cellX,
                        cellY,
                        Math.max(1, Math.round(item.spanX || 1)),
                        Math.max(1, Math.round(item.spanY || 1)),
                        itemType,
                        icon,
                        rank
                    ]);
                };

                // Process screens
                this.novaBackup.screens.forEach(screen => {
                    screen.items.forEach(item => {
                        insertItem(item, -100, item.screen || 0,
                            Math.round(item.cellX || 0), Math.round(item.cellY || 0),
                            item.rank || 0);
                    });
                });

                // Process dock (limited to detected dock columns)
                const hotseatLimit = this.novaBackup.dockCols || 5;
                this.novaBackup.dock.slice(0, hotseatLimit).forEach((item, index) => {
                    insertItem(item, -101, 0, index, 0, index);
                });

                // Process folder contents
                Object.entries(this.novaBackup.folders).forEach(([folderId, contents]) => {
                    const newFolderId = idMap[parseInt(folderId)];
                    if (!newFolderId) return; // Folder wasn't transferred

                    contents.forEach((item, index) => {
                        stmt.run([
                            id++,
                            item.title,
                            item.intent,
                            newFolderId, // Container is the folder ID
                            0,
                            0,
                            0,
                            1,
                            1,
                            item.itemType,
                            index
                        ]);
                    });
                });

                stmt.free();

                // Export to buffer
                const data = db.export();
                db.close();

                return data;
            },

            async generateLawnchairInfo() {
                const root = await protobuf.load('proto/lawnchair.proto');
                const BackupInfo = root.lookupType('BackupInfo');

                const info = {
                    lawnchairVersion: 1,
                    backupVersion: 1,
                    createdAt: {
                        seconds: Math.floor(Date.now() / 1000),
                        nanos: 0
                    },
                    gridState: {
                        gridSize: `${this.novaBackup.gridCols}x${this.novaBackup.gridRows}`,
                        hotseatCount: this.novaBackup.dockCols || 5
                    }
                };

                const errMsg = BackupInfo.verify(info);
                if (errMsg) throw new Error(errMsg);

                const message = BackupInfo.create(info);
                return BackupInfo.encode(message).finish();
            }
        }
    }
    </script>
</body>
</html>
